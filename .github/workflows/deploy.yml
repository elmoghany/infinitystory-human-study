name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Inject secrets with debug
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” DEBUG: Secret Injection Process"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo ""
          echo "ğŸ“‹ Step 1: Check if secrets are available"
          if [ -z "${{ secrets.GOOGLE_SHEETS_URL }}" ]; then
            echo "âŒ GOOGLE_SHEETS_URL is EMPTY!"
            exit 1
          else
            echo "âœ… GOOGLE_SHEETS_URL exists (length: ${#GOOGLE_SHEETS_URL})"
          fi
          
          if [ -z "${{ secrets.SPREADSHEET_ID }}" ]; then
            echo "âŒ SPREADSHEET_ID is EMPTY!"
            exit 1
          else
            echo "âœ… SPREADSHEET_ID exists: ${{ secrets.SPREADSHEET_ID }}"
          fi
          
          echo ""
          echo "ğŸ“‹ Step 2: BEFORE replacement"
          grep -n "GOOGLE_SHEETS_URL" html/comparison_script.js | head -2
          
          echo ""
          echo "ğŸ“‹ Step 3: Perform sed replacement"
          sed -i "s|{{GOOGLE_SHEETS_URL}}|${{ secrets.GOOGLE_SHEETS_URL }}|g" html/comparison_script.js
          sed -i "s|{{SPREADSHEET_ID}}|${{ secrets.SPREADSHEET_ID }}|g" google-apps-script.js
          sed -i "s|{{SPREADSHEET_ID}}|${{ secrets.SPREADSHEET_ID }}|g" google-apps-script-comparison.js
          echo "âœ… Replacements done"
          
          echo ""
          echo "ğŸ“‹ Step 4: AFTER replacement"
          grep -n "GOOGLE_SHEETS_URL" html/comparison_script.js | head -2
          
          echo ""
          echo "ğŸ“‹ Step 5: Verify"
          if grep -q "{{GOOGLE_SHEETS_URL}}" html/comparison_script.js; then
            echo "âŒ ERROR: Placeholder still exists!"
            exit 1
          fi
          
          echo "âœ… All secrets injected successfully!"
        env:
          GOOGLE_SHEETS_URL: ${{ secrets.GOOGLE_SHEETS_URL }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
  
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

